rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- UTILITY FUNCTIONS ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserDataSafe() {
      // Safe version that doesn't fail if document doesn't exist
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data : 
             null;
    }

    function isUserRole(role) {
      // Check both 'userType' and 'role' fields for broader compatibility
      let userData = getUserDataSafe();
      return isSignedIn() && userData != null && (userData.userType == role || userData.role == role);
    }

    function isTenant() { 
      return isUserRole('tenant');
    }

    function isPropertyOwner(propertyId) {
      let property = get(/databases/$(database)/documents/properties/$(propertyId)).data;
      return isSignedIn() && request.auth.uid == property.landlordId;
    }

    function isPropertyManager(propertyId) {
      let property = get(/databases/$(database)/documents/properties/$(propertyId)).data;
      // Check if a 'managers' field exists and the user's UID is in it.
      return isSignedIn() && property.keys().hasAny(['managers']) && request.auth.uid in property.managers;
    }

    

    function isContractor() {
      return isUserRole('contractor');
    }

    function isAdmin() {
      return isUserRole('admin');
    }

    function isContractorInLandlordRolodex(landlordId, contractorId) {
      let landlordProfile = get(/databases/$(database)/documents/landlordProfiles/$(landlordId)).data;
      return landlordProfile.contractors != null && contractorId in landlordProfile.contractors;
    }

    function isTenantOfLandlord(tenantId) {
      // Check if this tenant has a relationship with any properties owned by the landlord
      // This is a simplified check - in practice, you might want to query the propertyTenantRelationships collection
      return exists(/databases/$(database)/documents/users/$(tenantId)) && 
             get(/databases/$(database)/documents/users/$(tenantId)).data.userType == 'tenant';
    }

    // Function to check if a user is a landlord - enhanced version that takes userId parameter
    function isLandlord(userId) {
      return exists(/databases/$(database)/documents/landlordProfiles/$(userId));
    }

    // Function to check if current user is a landlord (backward compatibility)
    function isCurrentUserLandlord() {
      return isUserRole('landlord');
    }

    // Function to check if a user is a tenant of a specific landlord.
    function isTenantOf(landlordId, tenantId) {
      return exists(/databases/$(database)/documents/landlordProfiles/$(landlordId)) &&
             get(/databases/$(database)/documents/landlordProfiles/$(landlordId)).data.keys().hasAny(['acceptedTenants']) &&
             get(/databases/$(database)/documents/landlordProfiles/$(landlordId)).data.acceptedTenants.hasAny([tenantId]);
    }

    // Temporary function for debugging - allows landlords to read any tenant data
    // TODO: Remove this after debugging
    function isLandlordTemporaryAccess(userId) {
      return isLandlord(request.auth.uid);
    }

    // --- DATA VALIDATION FUNCTIONS ---
    // Email validation function removed as it was unused

    // --- RULES ---

    // Users Collection
    match /users/{userId} {
      // Users can read/update their own data, admins can access all
      allow read, update: if isOwner(userId) || isAdmin();
      
      // Allow landlords to read tenant data (with function to check relationship)
      allow read: if isLandlord(request.auth.uid) && isTenantOf(request.auth.uid, userId);
      
      // TEMPORARY DEBUG: Allow any landlord to read any user data for debugging
      // TODO: Remove this after fixing the isTenantOf function
      allow read: if isLandlordTemporaryAccess(userId);
      
      // Allow landlords to query for tenants (needed for PropertyTenantManager)
      allow list: if isCurrentUserLandlord();
      
      // Allow contractors to read user data for communication purposes
      allow read: if isContractor();
      
      // Anyone can create a user account
      allow create: if isSignedIn();
    }

    // Tenant Profiles Collection
    match /tenantProfiles/{tenantId} {
      // Tenants can always read/update their own profile
      // Landlords can read their tenants' profiles using the improved relationship check
      // Admins can access all
      allow read, update: if isOwner(tenantId) || 
                     (isLandlord(request.auth.uid) && isTenantOf(request.auth.uid, tenantId)) ||
                     isAdmin();
      
      // TEMPORARY DEBUG: Allow any landlord to read any tenant profile for debugging
      // TODO: Remove this after fixing the isTenantOf function
      allow read: if isLandlordTemporaryAccess(tenantId);
      
      // Allow creation during registration process
      allow create: if isOwner(tenantId) && (isTenant() || !exists(/databases/$(database)/documents/users/$(tenantId)));
      
      // Tenants can update their own profile
      // Landlords can update their tenants' profiles using the improved relationship check
      // Admins can update any profile
      allow update: if isOwner(tenantId) || 
                       (isLandlord(request.auth.uid) && isTenantOf(request.auth.uid, tenantId)) ||
                       isAdmin();
      
      allow delete: if isOwner(tenantId) || isAdmin();
    }

    // Contractor Profiles Collection - CRITICAL SECURITY FIX
    match /contractorProfiles/{contractorId} {
      // Helper function to check if update is only removing maintenance requests (for cleanup)
      function isMaintenanceRequestCleanupUpdate() {
        let changedFields = request.resource.data.diff(resource.data).affectedKeys();
        return changedFields.size() == 1 && 'maintenanceRequests' in changedFields;
      }

      // Contractors can read/update their own profile
      // Landlords can read contractor profiles in their rolodex
      // Admins can access all contractor profiles
      allow read: if isOwner(contractorId) || 
                     isCurrentUserLandlord() ||
                     isAdmin();
      // Allow creation during registration process or if user is already a contractor
      allow create: if isOwner(contractorId) && (isContractor() || !exists(/databases/$(database)/documents/users/$(contractorId)));
      
      // Allow updates by:
      // 1. The contractor themselves
      // 2. Landlords, but ONLY for maintenance request cleanup operations
      // 3. Admins (full access)
      allow update: if isOwner(contractorId) || 
                       isAdmin() ||
                       (isCurrentUserLandlord() && isMaintenanceRequestCleanupUpdate());
      
      allow delete: if isOwner(contractorId) || isAdmin();
    }

    // Landlord Profiles Collection - Enhanced Security Rules
    match /landlordProfiles/{landlordId} {
      // Helper function to check if update contains restricted fields
      function isRestrictedFieldUpdate() {
        let restrictedFields = ['acceptedTenants', 'invitesSent', 'acceptedTenantDetails'];
        return request.resource.data.diff(resource.data).affectedKeys().hasAny(restrictedFields);
      }

      // Helper function to check valid profile creation
      function isValidProfileCreation() {
        return isOwner(landlordId) && 
               request.resource.data.uid == request.auth.uid &&
               request.resource.data.landlordId == landlordId;
      }

      // Helper function to check valid profile update (excluding restricted fields)
      function isValidProfileUpdate() {
        return isOwner(landlordId) && 
               !isRestrictedFieldUpdate() &&
               request.resource.data.uid == resource.data.uid &&
               request.resource.data.landlordId == resource.data.landlordId;
      }

      // Read access: Landlords can read their own profile, contractors can read if in rolodex, admins can read all
      allow read, write: if isOwner(landlordId) ||
                     (isContractor() && isContractorInLandlordRolodex(landlordId, request.auth.uid)) ||
                     isAdmin();

      // Create access: Only the landlord can create their own profile with proper validation
      allow create: if isValidProfileCreation();

      // Update access: Landlords can update their own profile EXCEPT restricted fields, admins can update all
      allow update: if isValidProfileUpdate() || isAdmin();

      // Delete access: Only the owner or admin can delete the profile
      allow delete: if isOwner(landlordId) || isAdmin();

      // Explicit denial for restricted field updates by clients
      // Only Cloud Functions (using admin SDK) can modify these fields
      allow write: if false && isRestrictedFieldUpdate();
    }

    // Contractors Collection - for landlord's preferred contractors list
    match /contractors/{contractorId} {
      // Helper function to check if contractor belongs to the requesting landlord
      function isContractorOwner() {
        return isSignedIn() && resource.data.landlordId == request.auth.uid;
      }

      function isValidContractorCreation() {
        return isSignedIn() &&
               isCurrentUserLandlord() &&
               request.resource.data.landlordId == request.auth.uid;
      }

      // Landlords can read their own contractors, admins can read all
      allow read: if isSignedIn() && (
        (isCurrentUserLandlord() && resource.data.landlordId == request.auth.uid) ||
        isAdmin()
      );

      // Allow landlords to list their contractors
      allow list: if isSignedIn() && (isCurrentUserLandlord() || isAdmin());

      // Landlords can create contractors for themselves
      allow create: if isValidContractorCreation();

      // Landlords can update their own contractors
      allow update: if isSignedIn() && (
        isContractorOwner() ||
        isAdmin()
      );

      // Landlords can delete their own contractors
      allow delete: if isSignedIn() && (
        isContractorOwner() ||
        isAdmin()
      );
    }

    // Properties Collection
    match /properties/{propertyId} {
      // Helper function to check if update contains restricted fields
      function isPropertyRestrictedFieldUpdate() {
        let restrictedFields = ['tenants'];
        return request.resource.data.diff(resource.data).affectedKeys().hasAny(restrictedFields);
      }

      // Allow individual document reads for property owners, managers, tenants, and admins
      // More permissive read access for authenticated users
      allow get: if isSignedIn();
      // Allow listing properties for landlords (they can query their own properties)
      allow list: if isSignedIn() && (isCurrentUserLandlord() || isAdmin());
      allow create: if isSignedIn() && (isCurrentUserLandlord() || isAdmin());
      
      // Update access: Property owners can update EXCEPT tenants field, admins can update all
      // Also allow authenticated users to update for maintenance request functionality
      // Application logic ensures proper access control
      // Tenants need update access to remove their maintenance request IDs from the maintenanceRequests array
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && (isPropertyOwner(propertyId) || isAdmin());
    }

    // Tickets Collection
    match /tickets/{ticketId} {
      // Submitted by user, property owner/manager, assigned contractor, or admin can read/update
      allow read, update: if isSignedIn() && (
        isOwner(resource.data.submittedBy) || 
        isPropertyOwner(resource.data.propertyId) || 
        isPropertyManager(resource.data.propertyId) ||
        (isContractor() && resource.data.contractorId == request.auth.uid) ||
        isAdmin()
      );
      // Any signed-in user can create a ticket
      allow create: if isSignedIn(); 
    }

    // Invites Collection
    match /invites/{inviteId} {
      // Landlords and admins can manage invites.
      allow create: if isLandlord(request.auth.uid);
      
      // Allow reading for validation purposes (any authenticated user can validate invite codes)
      allow get: if request.auth != null;
      
      // Allow specific tenant and landlord access
      allow read, update: if (isLandlord(request.auth.uid) && resource.data.landlordId == request.auth.uid) ||
                             (isSignedIn() && resource.data.tenantEmail == request.auth.token.email) ||
                             isAdmin();
      
      // Allow querying invites for validation (needed for shortCode lookups)
      allow list: if isSignedIn();
      
      allow delete: if (isLandlord(request.auth.uid) && resource.data.landlordId == request.auth.uid) || isAdmin();
    }

    // New rule for invite codes, allows any authenticated user to read (for validation)
    match /inviteCodes/{code} {
        allow read: if isSignedIn();
        // Only cloud functions can create/write codes
        allow write: if false;
    }

    // Property Invitations Collection (for existing users)
    match /propertyInvitations/{invitationId} {
      // Landlords can read/manage invitations for their properties
      allow read, update, delete: if isSignedIn() && (
        (isCurrentUserLandlord() && resource.data.landlordId == request.auth.uid) ||
        isAdmin()
      );
      
      // Landlords can create invitations for their properties
      allow create: if isSignedIn() && (
        (isCurrentUserLandlord() && request.resource.data.landlordId == request.auth.uid) ||
        isAdmin()
      );
      
      // Tenants can read invitations sent to their email
      allow read: if isSignedIn() && resource.data.tenantEmail == request.auth.token.email;
      
      // Allow cloud functions to manage invitations
      allow write: if false; // Cloud functions will use admin SDK
    }

    // Generic mail collection for triggering emails
    match /mail/{mailId} {
      allow create: if isSignedIn(); // Allow any signed-in user to create an email document
    }

    // Notifications Collection
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      // Only cloud functions can create notifications
      allow create: if false;
      // Users can update their own notifications (mark as read, etc.)
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      // Users can delete their own notifications
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // Jobs Collection - for job/work order management
    match /jobs/{jobId} {
      // Property owners, assigned contractors, and admins can access jobs
      allow read, update: if isSignedIn() && (
        isPropertyOwner(resource.data.propertyId) ||
        (isContractor() && resource.data.contractorId == request.auth.uid) ||
        isAdmin()
      );
      // Property owners and admins can create jobs
      allow create: if isSignedIn() && (
        isCurrentUserLandlord() ||
        isAdmin()
      );
      // Property owners and admins can delete jobs
      allow delete: if isSignedIn() && (
        isPropertyOwner(resource.data.propertyId) ||
        isAdmin()
      );
    }

    // Disputes Collection - for handling disputes
    match /disputes/{disputeId} {
      // Involved parties (submitter, contractor, property owner) and admins can access
      allow read, update: if isSignedIn() && (
        resource.data.submittedBy == request.auth.uid ||
        resource.data.contractorId == request.auth.uid ||
        isPropertyOwner(resource.data.propertyId) ||
        isAdmin()
      );
      // Tenants and landlords can create disputes
      allow create: if isSignedIn() && (isTenant() || isCurrentUserLandlord());
      // Only admins can delete disputes
      allow delete: if isAdmin();
    }

    // Escrow Collection - for payment management
    match /escrow/{escrowId} {
      // Property owners, contractors involved, and admins can access
      allow read, update: if isSignedIn() && (
        isPropertyOwner(resource.data.propertyId) ||
        resource.data.contractorId == request.auth.uid ||
        isAdmin()
      );
      // Property owners and admins can create escrow
      allow create: if isSignedIn() && (isCurrentUserLandlord() || isAdmin());
      // Only admins can delete escrow records
      allow delete: if isAdmin();
    }

    // Conversations Collection - for real-time messaging
    match /conversations/{conversationId} {
      function isParticipant() {
        return isSignedIn() && request.auth.uid in resource.data.participants;
      }

      function isValidParticipant() {
        return isSignedIn() && 
               request.auth.uid in request.resource.data.participants;
      }

      // Read conversations if user is a participant
      allow read: if isParticipant();
      
      // Create conversations if user is one of the participants
      allow create: if isValidParticipant();
      
      // Update conversations if user is a participant (for marking as read, etc.)
      allow update: if isParticipant();
      
      // Delete conversations if user is a participant
      allow delete: if isParticipant();
    }

    // Messages Collection - for individual messages
    match /messages/{messageId} {
      function isMessageParticipant() {
        let conversation = get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data;
        return isSignedIn() && request.auth.uid in conversation.participants;
      }

      function canCreateMessage() {
        let conversation = get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data;
        return isSignedIn() && 
               request.auth.uid in conversation.participants &&
               request.resource.data.senderId == request.auth.uid;
      }

      // Read messages if user is participant of the conversation
      allow read: if isMessageParticipant();
      
      // Create messages if user is participant and sender matches auth
      allow create: if canCreateMessage();
      
      // Update messages if user is participant (for marking as read, editing)
      allow update: if isMessageParticipant();
      
      // Delete messages if user is the sender
      allow delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
    }

    // Maintenance Requests Collection (camelCase) - PRIMARY COLLECTION
    match /maintenanceRequests/{requestId} {
      // Helper function to check if user owns the property associated with this maintenance request
      function isMaintenanceRequestPropertyOwner() {
        return isSignedIn() && isPropertyOwner(resource.data.propertyId);
      }

      function isMaintenanceRequestCreationValid() {
        return isSignedIn() && 
               request.auth.uid == request.resource.data.tenantId &&
               exists(/databases/$(database)/documents/properties/$(request.resource.data.propertyId));
      }

      // Tenants can read/update their own maintenance requests
      // Property owners can read/update requests for their properties
      // Contractors can read/update requests assigned to them
      // Admins can access all
      allow read, update: if isSignedIn() && (
        resource.data.submittedBy == request.auth.uid ||
        resource.data.tenantId == request.auth.uid ||
        isMaintenanceRequestPropertyOwner() ||
        (isContractor() && resource.data.keys().hasAny(['contractorId']) && resource.data.contractorId == request.auth.uid) ||
        isAdmin()
      );
      
      // Allow authenticated users to create maintenance requests with proper validation
      allow create: if isMaintenanceRequestCreationValid();
      
      // **CRITICAL**: Property owners can delete maintenance requests for their properties
      // Tenants can delete their own requests
      // Admins can delete all requests
      allow delete: if isSignedIn() && (
        resource.data.submittedBy == request.auth.uid ||
        resource.data.tenantId == request.auth.uid ||
        isMaintenanceRequestPropertyOwner() ||
        isAdmin()
      );
      
      // Allow listing for property owners, contractors, and admins
      allow list: if isSignedIn() && (
        isCurrentUserLandlord() || 
        isContractor() || 
        isAdmin()
      );
    }



    // Property-Tenant Relationships Collection
    match /propertyTenantRelationships/{relationshipId} {
      // Property owners can read/manage relationships for their properties
      allow read, update, delete: if isSignedIn() && (
        isPropertyOwner(resource.data.propertyId) ||
        isAdmin()
      );
      
      // Property owners can create relationships for their properties
      allow create: if isSignedIn() && (
        isPropertyOwner(request.resource.data.propertyId) ||
        isAdmin()
      );
      
      // Tenants can read their own relationships
      allow read: if isSignedIn() && resource.data.tenantId == request.auth.uid;
      
      // Allow listing relationships for property owners (needed for getPropertyTenants)
      allow list: if isSignedIn() && isCurrentUserLandlord();
    }
  }
}